service: cdk-routing-split

plugins:
    - serverless-prune-plugin
    - serverless-plugin-modularize
    - serverless-newrelic-lambda-layers
    - serverless-export-env

package:
    excludeDevDependencies: true
    exclude:
        - '**'
        - '!node_modules/**'
    include:
        - 'dist/**'

provider:
    name: aws
    runtime: nodejs14.x
    lambdaHashingVersion: 20201221
    region: us-east-1
    stage: ${opt:stage, "sandbox"}
    timeout: 120
    memorySize: 192
    tracing:
        apiGateway: true

custom:
    name: ${self:service}-${opt:stage, self:provider.stage}
    config: ${file(infrastructure/config.${opt:stage, self:provider.stage}.yml)}
    newRelic:
        accountId: 1464764
        enableExtension: false
        enableIntegrations: false
    output:
        file: ./output-${opt:stage}.json
    prune:
        automatic: true
        number: 3
    modularize:
        glob: 'src/**/serverless.module.yml'

resources:
    Resources:
        LoggingServiceRole:
            Type: 'AWS::IAM::Role'
            Properties:
                RoleName: 'CloudwatchLogging-${self:custom.name}-Role'
                AssumeRolePolicyDocument:
                    Version: '2012-10-17'
                    Statement:
                        - Effect: 'Allow'
                          Principal:
                              Service:
                                  - 'appsync.amazonaws.com'
                          Action:
                              - 'sts:AssumeRole'
                Policies:
                    - PolicyName: 'CloudwatchLogging-${self:custom.name}-Policy'
                      PolicyDocument:
                          Version: '2012-10-17'
                          Statement:
                              - Effect: 'Allow'
                                Action:
                                    - 'logs:CreateLogGroup'
                                    - 'logs:CreateLogStream'
                                    - 'logs:PutLogEvents'
                                Resource:
                                    - '*'
