service: cdk-routing-split

plugins:
    - serverless-prune-plugin
    - serverless-plugin-modularize
    - serverless-newrelic-lambda-layers
    - serverless-export-env

package:
    excludeDevDependencies: true
    exclude:
        - '**'
        - '!node_modules/**'
    include:
        - 'dist/**'

provider:
    name: aws
    runtime: nodejs14.x
    lambdaHashingVersion: 20201221
    region: us-east-1
    stage: ${opt:stage, "sandbox"}
    timeout: 120
    memorySize: 192
    tracing:
        apiGateway: true
    environment:
        DEBUG: ${self:custom.config.DEBUG, false}
        CDK_ROUTING_SPLIT_TABLE: ${self:custom.config.CDK_ROUTING_SPLIT_TABLE}

custom:
    name: ${self:service}-${opt:stage, self:provider.stage}
    config:
        API_GATEWAY_SUB_DOMAIN: olbroutingservice
        HOST_DOMAIN: daysmart.com
        CERTIFICATE_ARN: arn:aws:acm:us-east-1:933922255734:certificate/3d09aac7-844f-4f8d-a925-3b6c025924c0
        DEBUG: 'true'
        CDK_ROUTING_SPLIT_TABLE: cdk-routing-split-sandbox
    newRelic:
        accountId: 1464764
        enableExtension: false
        enableIntegrations: false
    output:
        file: ./output-${opt:stage}.json
    prune:
        automatic: true
        number: 3
    modularize:
        glob: 'src/**/serverless.module.yml'

resources:
    Resources:
        dynamoDbTable:
            Type: AWS::DynamoDB::Table
            Properties:
                SSESpecification:
                    SSEEnabled: true
                TableName: ${self:custom.config.CDK_ROUTING_SPLIT_TABLE}
                AttributeDefinitions:
                    - AttributeName: PK
                      AttributeType: S
                KeySchema:
                    - AttributeName: PK
                      KeyType: HASH
                BillingMode: PAY_PER_REQUEST
        domainName:
            Type: 'AWS::ApiGateway::DomainName'
            DependsOn: ApiGatewayRestApi
            Properties:
                DomainName: ${self:custom.config.API_GATEWAY_SUB_DOMAIN}.${self:custom.config.HOST_DOMAIN}
                CertificateArn: ${self:custom.config.CERTIFICATE_ARN}
        basePathMapping:
            Type: 'AWS::ApiGateway::BasePathMapping'
            DependsOn: domainName
            Properties:
                BasePath: api
                DomainName: ${self:custom.config.API_GATEWAY_SUB_DOMAIN}.${self:custom.config.HOST_DOMAIN}
                RestApiId: { 'Ref': 'ApiGatewayRestApi' }
                Stage: ${opt:stage, self:provider.stage}
